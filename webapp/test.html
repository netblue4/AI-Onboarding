<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Onboarding Procedure</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <h1 id="main-title">Loading...</h1>
        <div id="form-container"></div>
        <button id="next-btn">Next</button>
        <button id="download-btn" style="display: none;">Download JSON</button>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // Fetch the external JSON data from the 'webappData.json' file
        fetch('ai_onboarding_procedure_data.json')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Network response was not ok: ${response.statusText}`);
                }
                return response.json();
            })
            .then(webappData => {
                // The rest of the application logic is now placed inside this .then() block,
                // ensuring it only runs after the data has been successfully loaded.
                
                const formContainer = document.getElementById('form-container');
                const nextBtn = document.getElementById('next-btn');
                const downloadBtn = document.getElementById('download-btn');
                const mainTitle = document.getElementById('main-title');

                const capturedData = {};
                const procedureSteps = Object.keys(webappData);
                let currentStepIndex = 0;

                // Sanitizes a string to be used as a valid HTML ID.
                function sanitizeForId(text) {
                    if (typeof text !== 'string') return '';
                    return text.replace(/[^a-zA-Z0-9_]/g, '_');
                }

                // Renders the current step of the form based on the currentStepIndex.
                function renderCurrentStep() {
                    const stepKey = procedureSteps[currentStepIndex];
                    const stepData = webappData[stepKey];
                    
                    if (!stepData) {
                        mainTitle.textContent = "Error";
                        formContainer.innerHTML = "<p>Could not find data for the current step. Please check the data source.</p>";
                        return;
                    }

                    mainTitle.textContent = stepData.WebFormTitle || "Procedure Step";
                    formContainer.innerHTML = ''; 

                    const formStepDiv = document.createElement('div');
                    formStepDiv.className = 'form-step';

                    // Check if the step is a note or a decision point (has no actual fields).
                    if (!stepData.Fields || stepData.Fields.length === 0 || !stepData.Fields[0].FieldName) {
                         const note = document.createElement('p');
                         note.textContent = "This is a procedural note or a decision point. Click 'Next' to continue.";
                         formStepDiv.appendChild(note);
                    } else {
                        // Dynamically create form fields based on the JSON data.
                        stepData.Fields.forEach(field => {
                            if (!field || !field.FieldName) return; // Skip empty/invalid field objects
                            
                            const fieldDiv = document.createElement('div');
                            fieldDiv.className = 'form-field';
                            const sanitizedId = sanitizeForId(field.FieldName);

                            if (field.FieldType === 'Auto generated number') {
                                const label = document.createElement('label');
                                label.textContent = field.FieldLabel + ': ';
                                const span = document.createElement('span');
                                span.className = 'auto-generated-label';
                                const uniqueId = 'AutoGen_' + Date.now() + '_' + Math.floor(Math.random() * 1000);
                                span.textContent = uniqueId;
                                fieldDiv.appendChild(label);
                                fieldDiv.appendChild(span);
                                capturedData[field.FieldName] = uniqueId; // Pre-capture auto-generated value
                            } else if (field.FieldType === 'TextBox') {
                                const label = document.createElement('label');
                                label.setAttribute('for', sanitizedId);
                                label.textContent = field.FieldLabel;
                                const input = document.createElement('textarea');
                                input.id = sanitizedId;
                                input.name = sanitizedId;
                                input.rows = 3;
                                fieldDiv.appendChild(label);
                                fieldDiv.appendChild(input);
                            } else if (field.FieldType && field.FieldType.startsWith('Dropdown box with values')) {
                                const label = document.createElement('label');
                                label.setAttribute('for', sanitizedId);
                                label.textContent = field.FieldLabel;
                                const select = document.createElement('select');
                                select.id = sanitizedId;
                                select.name = sanitizedId;
                                
                                const optionsString = field.FieldType.split(':')[1]?.trim() || '';
                                const options = optionsString.split('/');
                                
                                options.forEach(optionText => {
                                    const option = document.createElement('option');
                                    option.value = optionText.trim();
                                    option.textContent = optionText.trim();
                                    select.appendChild(option);
                                });
                                
                                fieldDiv.appendChild(label);
                                fieldDiv.appendChild(select);
                            }
                            formStepDiv.appendChild(fieldDiv);
                        });
                    }
                    formContainer.appendChild(formStepDiv);
                }

                // Event listener for the 'Next' button.
                nextBtn.addEventListener('click', () => {
                    const currentStepKey = procedureSteps[currentStepIndex];
                    const stepData = webappData[currentStepKey];

                    // Capture data from the current form fields before moving to the next step.
                    if (stepData && stepData.Fields) {
                        stepData.Fields.forEach(field => {
                            if (field && field.FieldName && field.FieldType !== 'Auto generated number') {
                                const sanitizedId = sanitizeForId(field.FieldName);
                                const inputElement = document.getElementById(sanitizedId);
                                if (inputElement) {
                                    capturedData[field.FieldName] = inputElement.value;
                                }
                            }
                        });
                    }

                    currentStepIndex++;
                    if (currentStepIndex < procedureSteps.length) {
                        renderCurrentStep();
                    } else {
                        // End of the procedure.
                        formContainer.innerHTML = '<h2>Onboarding procedure completed!</h2><p>You can now download the generated JSON file containing all your input.</p>';
                        mainTitle.textContent = "Finished";
                        nextBtn.style.display = 'none';
                        downloadBtn.style.display = 'block';
                    }
                });

                // Event listener for the 'Download' button.
                downloadBtn.addEventListener('click', () => {
                    const jsonData = JSON.stringify(capturedData, null, 4);
                    const blob = new Blob([jsonData], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'onboarding_documentation.json';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                });

                // Initial render of the first step.
                renderCurrentStep();
            })
            .catch(error => {
                // Handle errors during the fetch operation (e.g., file not found).
                console.error('Error loading the webapp data:', error);
                mainTitle.textContent = "Error";
                formContainer.innerHTML = "<p>Failed to load procedure data. Please check the console for errors and ensure 'webappData.json' is available in the same directory.</p>";
            });
    });
    </script>
</body>
</html>
