<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AI Compliance Gap Analyzer</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f8fafc; margin: 0; overflow: hidden; }
        #controls { position: absolute; top: 20px; left: 20px; z-index: 10; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); border: 1px solid #e2e8f0; max-width: 250px; }
        .node circle { cursor: pointer; stroke-width: 2.5px; }
        .node text { font-size: 11px; pointer-events: none; fill: #334155; }
        .link { fill: none; stroke: #cbd5e1; stroke-width: 1.5px; transition: all 0.3s; }
        
        /* Matching your fieldHandler_comply.js aesthetic */
        .node-regulation circle { fill: #dbeafe; stroke: #1e40af; }
        .node-requirement circle { fill: #fef08a; stroke: #a16207; }
        .node-risk circle { fill: #fee2e2; stroke: #b91c1c; }
        .node-plan circle { fill: #dcfce7; stroke: #15803d; }
        .node-control circle { fill: #f1f5f9; stroke: #475569; }

        .tooltip { position: absolute; padding: 10px; background: #1e293b; color: white; border-radius: 6px; font-size: 12px; pointer-events: none; max-width: 300px; z-index: 20; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        .legend-item { display: flex; align-items: center; font-size: 11px; margin-bottom: 5px; }
        .legend-color { width: 10px; height: 10px; border-radius: 50%; margin-right: 8px; }
    </style>
</head>
<body>

<div id="controls">
    <h3 style="margin:0 0 10px 0; font-size:14px; color:#1e40af;">AI Act Gap Analyzer</h3>
    <div class="legend">
        <div class="legend-item"><div class="legend-color" style="background:#dbeafe; border:1px solid #1e40af"></div> Field Group</div>
        <div class="legend-item"><div class="legend-color" style="background:#fef08a; border:1px solid #a16207"></div> Requirement</div>
        <div class="legend-item"><div class="legend-color" style="background:#fee2e2; border:1px solid #b91c1c"></div> Risk</div>
        <div class="legend-item"><div class="legend-color" style="background:#dcfce7; border:1px solid #15803d"></div> Test Plan</div>
        <div class="legend-item"><div class="legend-color" style="background:#f1f5f9; border:1px solid #475569"></div> Technical Control</div>
    </div>
    <p style="font-size: 10px; color: #64748b; margin-top: 10px;">Click nodes to Expand/Collapse.<br>Drag to Pan. Scroll to Zoom.</p>
</div>

<div id="mindmap"></div>

<script>
let i = 0;
let root;
const margin = {top: 20, right: 120, bottom: 20, left: 120};
const width = window.innerWidth;
const height = window.innerHeight;
const treeLayout = d3.tree().nodeSize([30, 250]);

const svg = d3.select("#mindmap").append("svg")
    .attr("width", width)
    .attr("height", height)
    .call(d3.zoom().scaleExtent([0.1, 3]).on("zoom", (event) => g.attr("transform", event.transform)))
    .append("g");

const g = svg.append("g")
    .attr("transform", `translate(${margin.left},${height/2})`);

const tooltip = d3.select("body").append("div").attr("class", "tooltip").style("opacity", 0);

// --- DATA PROCESSING (Similar to buildComplianceMap logic) ---
async function loadAndProcessData() {
    const rawData = await fetch('ai_onboarding_procedure_data.json').then(r => r.json());
    
    const hierarchy = { name: "AI Compliance", type: "root", children: [] };
    const reqLookup = new Map();

    // Pass 1: Build Articles (Requirements)
    Object.values(rawData).flat().forEach(step => {
        if (!step.Fields) return;
        step.Fields.forEach(group => {
            if (group.jkType === 'fieldGroup') {
                const groupNode = { 
                    name: group.jkName, 
                    type: 'regulation', 
                    details: `Role: ${group.Role}`, 
                    children: [] 
                };
                hierarchy.children.push(groupNode);

                if (group.controls) {
                    group.controls.forEach(ctrl => {
                        if (ctrl.jkType === 'requirement') {
                            const reqNode = {
                                id: ctrl.requirement_control_number,
                                name: `${ctrl.requirement_control_number}`,
                                type: 'requirement',
                                details: ctrl.jkText,
                                children: []
                            };
                            groupNode.children.push(reqNode);
                            reqLookup.set(ctrl.requirement_control_number, reqNode);
                        }
                    });
                }
            }
        });
    });

    // Pass 2: Link Risks, Plans, and Fields via requirement_control_number
    Object.values(rawData).flat().forEach(step => {
        if (!step.Fields) return;
        step.Fields.forEach(item => {
            if (item.requirement_control_number && item.jkType !== 'requirement') {
                const targets = String(item.requirement_control_number).split(',').map(s => s.trim());
                targets.forEach(t => {
                    if (reqLookup.has(t)) {
                        const implNode = {
                            name: item.jkName || "Implementation",
                            type: item.jkType === 'risk' ? 'risk' : 'plan',
                            details: item.RiskDescription || item.PlanObjective,
                            children: []
                        };
                        // Add nested controls
                        if (item.controls) {
                            item.controls.forEach(c => {
                                implNode.children.push({
                                    name: c.control_number,
                                    type: 'control',
                                    details: c.jkText,
                                    children: null // Leaf node
                                });
                            });
                        }
                        reqLookup.get(t).children.push(implNode);
                    }
                });
            }
        });
    });

    root = d3.hierarchy(hierarchy);
    root.x0 = height / 2;
    root.y0 = 0;

    // Collapse all nodes by default except first level
    root.children.forEach(collapse);
    update(root);
}

function collapse(d) {
    if (d.children) {
        d._children = d.children;
        d._children.forEach(collapse);
        d.children = null;
    }
}

function update(source) {
    const nodes = treeLayout(root).descendants();
    const links = treeLayout(root).links();

    nodes.forEach(d => { d.y = d.depth * 250; });

    // Nodes Section
    const node = g.selectAll('g.node')
        .data(nodes, d => d.id || (d.id = ++