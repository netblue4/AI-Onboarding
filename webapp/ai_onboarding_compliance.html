<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Regulatory Risk & Implementation Mapping</title>
    <style>
        :root {
            --primary-color: #2563eb;
            --secondary-color: #475569;
            --success-color: #22c55e;
            --bg-light: #f8fafc;
            --border-color: #e2e8f0;
            --border-color-dashed: #cbd5e1;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            line-height: 1.6;
            color: #334155;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: var(--bg-light);
        }

        h1 {
            color: #1e293b;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 10px;
        }

        #loading, #error {
            padding: 20px;
            font-size: 1.2em;
        }
        #error { color: #dc2626; }

        .mapping-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            margin-top: 20px;
            padding: 0;
            overflow: hidden; /* For border-radius */
        }

        /* Top-level Regulatory Requirement Node */
        .reg-item {
            margin-bottom: 25px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden; /* Ensure header radius applies */
        }

        .reg-header {
            background-color: #eff6ff;
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex; /* Use flexbox for alignment */
            align-items: center;
            cursor: pointer; /* Indicate it's clickable */
            transition: background-color 0.2s ease;
        }

        .reg-header:hover {
            background-color: #e0e7ff;
        }

        .toggle-icon {
            font-size: 1.5em;
            font-weight: bold;
            color: var(--primary-color);
            margin-right: 15px;
            transition: transform 0.2s ease;
            width: 20px; /* Reserve space */
            text-align: center;
            flex-shrink: 0;
        }

        .toggle-icon.expanded {
            transform: rotate(90deg);
        }
        
        .reg-header-content {
            flex-grow: 1; /* Take remaining space */
            min-width: 0; /* Prevent overflow */
        }

        .reg-title {
            font-size: 1.2em;
            font-weight: 700;
            color: #1e40af;
            margin: 0;
            margin-bottom: 8px; /* Add space for progress bar */
            word-wrap: break-word;
        }
        
        .reg-meta {
            font-size: 0.9em;
            color: var(--secondary-color);
            margin-top: 8px;
            word-wrap: break-word;
        }

        /* New Progress Bar Styles */
        .progress-container {
            width: 100%;
            height: 18px;
            background-color: #e0e7ff; /* Lighter blue */
            border-radius: 9px;
            overflow: hidden;
            position: relative;
        }

        .progress-bar {
            height: 100%;
            width: 0%; /* Will be set by inline style */
            background-color: var(--primary-color);
            transition: width 0.4s ease-out;
        }

        .progress-text {
            position: absolute;
            width: 100%;
            top: 0;
            left: 0;
            text-align: center;
            font-size: 0.8em; /* 12.8px */
            line-height: 18px; /* Match container height */
            font-weight: 600;
            color: #1e3a8a; /* Darker blue for contrast */
        }

        /* List of Sub-Controls */
        .sub-control-list {
            list-style: none;
            padding: 0;
            margin: 0;
            display: none; /* Hide by default */
            background-color: #ffffff;
        }

        .sub-control-list.expanded {
            display: block; /* Show when expanded */
        }

        /* Individual Sub-Control Item */
        .sub-control-item {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
        }
        .sub-control-item:last-child {
            border-bottom: none;
        }

        .sub-control-title {
            font-weight: 600;
            color: #1e293b;
            font-size: 1em;
            margin-bottom: 10px;
            word-wrap: break-word;
        }

        /* List of Implementations (under a sub-control) */
        .imp-list {
            list-style: none;
            padding: 0;
            margin: 0;
            margin-top: 10px;
            padding-left: 15px;
            border-left: 3px solid var(--border-color);
        }

        /* Individual Implementation Item */
        .imp-item {
            padding: 10px;
            display: flex;
            align-items: flex-start;
            background-color: #f9fafb;
            border-radius: 4px;
            margin-bottom: 8px;
        }
        .imp-item:last-child {
            margin-bottom: 0;
        }

        .imp-type-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 600;
            text-transform: uppercase;
            margin-right: 10px;
            min-width: 50px;
            text-align: center;
            margin-top: 3px;
            white-space: nowrap;
        }

        .type-risk { background-color: #fee2e2; color: #991b1b; }
        .type-plan { background-color: #dcfce7; color: #166534; }
        .type-other { background-color: #e2e8f0; color: #475569; } /* New badge for other types */

        .imp-content {
            flex: 1;
            min-width: 0; /* Prevents long text from overflowing */
        }

        .imp-title {
            font-weight: 500;
            font-size: 0.95em;
            word-wrap: break-word; /* Handle long field names */
        }

        .imp-meta {
            font-size: 0.85em;
            color: #64748b;
            margin-top: 2px;
            word-wrap: break-word; /* Handle long control strings */
        }

        .no-children {
            padding: 5px 0 0 15px;
            color: var(--secondary-color);
            font-size: 0.9em;
            font-style: italic;
        }
    </style>
</head>
<body>

    <h1>Regulatory Compliance to Implementation Mapping</h1>
    
    <div id="loading">Loading onboarding procedure data...</div>
    <div id="error" style="display: none;"></div>
    <div id="content" class="mapping-container" style="display: none;"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const loadingEl = document.getElementById('loading');
            const errorEl = document.getElementById('error');
            const contentEl = document.getElementById('content');

            // --- Event Listener for Collapsible Sections ---
            // We add it to the contentEl which exists from the start
            contentEl.addEventListener('click', event => {
                // Use .closest() to find the header, even if user clicks an inner element
                const header = event.target.closest('.reg-header');
                if (!header) return; // Didn't click a header

                const targetId = header.getAttribute('data-target');
                if (!targetId) return;

                const content = document.querySelector(targetId);
                const icon = header.querySelector('.toggle-icon');

                if (content && icon) {
                    // Toggle the 'expanded' class
                    const isExpanded = content.classList.toggle('expanded');
                    
                    // Update icon and aria attributes
                    if (isExpanded) {
                        icon.textContent = 'âˆ’'; // Minus sign
                        icon.classList.add('expanded');
                        header.setAttribute('aria-expanded', 'true');
                        content.setAttribute('aria-hidden', 'false');
                    } else {
                        icon.textContent = '+';
                        icon.classList.remove('expanded');
                        header.setAttribute('aria-expanded', 'false');
                        content.setAttribute('aria-hidden', 'true');
                    }
                }
            });

            fetch('ai_onboarding_procedure_data.json')
                .then(response => {
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    return response.json();
                })
                .then(data => {
                    processAndRenderData(data);
                    loadingEl.style.display = 'none';
                    contentEl.style.display = 'block';
                })
                .catch(err => {
                    loadingEl.style.display = 'none';
                    errorEl.textContent = `Error loading data: ${err.message}. Please ensure 'ai_onboarding_procedure_data.json' is in the same directory.`;
                    errorEl.style.display = 'block';
                });
        });

        /**
         * Helper function to check if a field's TrustDimension contains a specific tag.
         */
        function hasTrustDimension(field, dimension) {
            if (!field || !field.TrustDimension || typeof field.TrustDimension !== 'string') {
                return false;
            }
            return field.TrustDimension.split(',').map(s => s.trim()).includes(dimension);
        }

        /**
         * Helper function to extract the control key (e.g., "[Art-10][Par-2][1]")
         * from the full control string.
         */
        function getControlKey(controlString) {
            if (typeof controlString !== 'string') return null;
            // Split at the " - " separator and take the first part
            const key = controlString.split(' - ')[0].trim();
            // Basic validation: must start with '[' and end with ']'
            if (key.startsWith('[') && key.endsWith(']')) {
                return key;
            }
            return null; // Return null if format is unexpected
        }

        function processAndRenderData(webappData) {
            // 1. Flatten all steps and extract all fields
            let allFields = [];
            Object.values(webappData).flat().forEach(step => {
                if (step.Fields && Array.isArray(step.Fields)) {
                    allFields = allFields.concat(step.Fields);
                }
            });

            // 2. Separate nodes into Requirements (Parents) and Implementations (Children)
            const requirementNodes = [];
            const implementationNodes = [];

            allFields.forEach(field => {
                if (hasTrustDimension(field, 'Requirement')) {
                    requirementNodes.push(field);
                } 
                else if (field.FieldType === 'fieldGroup' && field.Fields && Array.isArray(field.Fields)) {
                    // This is a fieldGroup, so we treat its *inner fields* as potential implementations
                    field.Fields.forEach(innerField => {
                        // Only add if it has a control to match
                        if (innerField.Control) {
                            implementationNodes.push(innerField);
                        }
                    });
                }
                else if (field.Control) {
                    // This catches top-level 'risk', 'plan', and any other field
                    // that is not a Requirement but has a Control.
                    implementationNodes.push(field);
                }
            });

            // 3. Build the compliance map.
            //    Key: Parent Requirement's FieldName
            //    Value: { parentField: object, subControlLinks: Map<string, { subControl: object, children: Set<object> }> }
            const complianceMap = new Map();

            requirementNodes.forEach(reqNode => {
                const subControlMap = new Map();
                
                if (reqNode.controls && Array.isArray(reqNode.controls)) {
                    reqNode.controls.forEach(subControl => {
                        const controlKey = getControlKey(subControl.control);
                        if (controlKey) {
                            subControlMap.set(controlKey, {
                                subControl: subControl, // The full sub-control object
                                children: new Set()   // Place to store matching implementations
                            });
                        }
                    });
                }
                
                complianceMap.set(reqNode.FieldName, {
                    parentField: reqNode,
                    subControlLinks: subControlMap
                });
            });

            // 4. Link Implementations (Children) to the mapped Sub-Controls
            implementationNodes.forEach(implNode => {
                if (!implNode.Control) return; // This implementation can't be linked
                
                const implControlParts = implNode.Control.split(',').map(s => s.trim());

                // Check this implementation's keys against ALL sub-controls in our map
                for (const [parentName, data] of complianceMap.entries()) {
                    const subControlLinks = data.subControlLinks; // This is the Map
                    
                    for (const implKey of implControlParts) {
                        if (subControlLinks.has(implKey)) {
                            // Found a match! Add this child.
                            subControlLinks.get(implKey).children.add(implNode);
                        }
                    }
                }
            });

            // 5. Render the new, nested structure
            renderMapping(complianceMap);
        }

        function renderMapping(complianceMap) {
            const container = document.getElementById('content');
            container.innerHTML = '';

            if (complianceMap.size === 0) {
                 container.innerHTML = '<p>No "Requirement" nodes found in the data. Please check the JSON file for fields with "Requirement" in their TrustDimension.</p>';
                 return;
            }

            // Sort top-level requirements by FieldName
            const sortedEntries = Array.from(complianceMap.entries()).sort((a, b) => a[0].localeCompare(b[0]));

            sortedEntries.forEach(([parentFieldName, data]) => {
                const parent = data.parentField;
                const subControlLinks = data.subControlLinks; // The Map

                const regItem = document.createElement('div');
                regItem.className = 'reg-item';

                // --- Calculate Progress ---
                const totalSubControls = subControlLinks.size;
                let matchedSubControls = 0;
                
                subControlLinks.forEach(subControlData => {
                    if (subControlData.children.size > 0) {
                        matchedSubControls++;
                    }
                });

                // If 0/0, treat as 100% complete (N/A)
                const percentage = (totalSubControls > 0) ? (matchedSubControls / totalSubControls) * 100 : 0;
                const displayPercentage = (totalSubControls === 0) ? 100 : percentage;
                const progressText = (totalSubControls === 0) ? "N/A" : `${matchedSubControls} / ${totalSubControls}`;
                // Use green for 100%, blue otherwise
                const progressColor = (displayPercentage >= 100) ? 'var(--success-color)' : 'var(--primary-color)';

                // Create a unique ID for the collapsible content
                const contentId = `content-${parentFieldName.replace(/[^a-zA-Z0-9_]/g, '-')}`;

                // --- Render Regulatory Node Header ---
                const regHeader = document.createElement('div');
                regHeader.className = 'reg-header';
                regHeader.setAttribute('data-target', `#${contentId}`); // Link to content ID
                regHeader.setAttribute('aria-expanded', 'false');
                regHeader.setAttribute('aria-controls', contentId);
                regHeader.innerHTML = `
                    <div class="toggle-icon">+</div>
                    <div class="reg-header-content">
                        <div class="reg-title">${escapeHtml(parent.FieldName + ' - ' + parent.Control)}</div>
                        
                        <!-- Progress Bar -->
                        <div class="progress-container" title="Compliance Progress: ${progressText}">
                            <div class="progress-bar" style="width: ${displayPercentage}%; background-color: ${progressColor};"></div>
                            <div class="progress-text">${progressText}</div>
                        </div>

                        <div class="reg-meta"><strong>Top-level Control:</strong> ${escapeHtml(parent.Control)} | <strong>Trust Dimension:</strong> ${escapeHtml(parent.TrustDimension || 'N/A')}</div>
                    </div>
                `;
                regItem.appendChild(regHeader);


                // --- Render List of Sub-Controls ---
                const subControlList = document.createElement('ul');
                subControlList.className = 'sub-control-list'; // No 'expanded' by default
                subControlList.id = contentId;
                subControlList.setAttribute('aria-hidden', 'true');

                if (subControlLinks.size === 0) {
                    const noSubItems = document.createElement('li');
                    noSubItems.className = 'sub-control-item';
                    noSubItems.textContent = 'No specific sub-controls defined in the "controls" array for this requirement.';
                    subControlList.appendChild(noSubItems);
                } else {
                    // Sort sub-controls by their key (e.g., [Art-10][Par-2][1])
                    const sortedSubControls = Array.from(subControlLinks.entries()).sort((a, b) => a[0].localeCompare(b[0]));
                    
                    sortedSubControls.forEach(([subControlKey, subControlData]) => {
                        const subControl = subControlData.subControl;
                        const children = subControlData.children; // The Set

                        const subControlItem = document.createElement('li');
                        subControlItem.className = 'sub-control-item';
                        
                        // Add sub-control title
                        const subControlTitle = document.createElement('div');
                        subControlTitle.className = 'sub-control-title';
                        subControlTitle.textContent = escapeHtml(subControl.control);
                        subControlItem.appendChild(subControlTitle);

                        // --- Render List of Implementations for this Sub-Control ---
                        if (children.size === 0) {
                            const noChildren = document.createElement('div');
                            noChildren.className = 'no-children';
                            noChildren.textContent = 'No matching implementation risks or plans found.';
                            subControlItem.appendChild(noChildren);
                        } else {
                            const impList = document.createElement('ul');
                            impList.className = 'imp-list';

                            const sortedChildren = Array.from(children).sort((a, b) => (a.FieldName || '').localeCompare(b.FieldName || ''));

                            sortedChildren.forEach(child => {
                                const impItem = document.createElement('li');
                                impItem.className = 'imp-item';
                                
                                // *** UPDATED BADGE LOGIC (from previous request) ***
                                let typeClass = 'type-other';
                                let typeName = child.FieldType || 'field'; // Get the original field type

                                if (typeName === 'risk') {
                                    typeClass = 'type-risk';
                                    // typeName is already 'risk'
                                } else if (typeName === 'plan') {
                                    typeClass = 'type-plan';
                                    // typeName is already 'plan'
                                } else {
                                    // If it's not 'risk' or 'plan', set it to 'FIELD'
                                    typeClass = 'type-other';
                                    typeName = 'FIELD'; // Set the display name to FIELD
                                }
                                
                                impItem.innerHTML = `
                                    <span class="imp-type-badge ${typeClass}">${escapeHtml(typeName)}</span>
                                    <div class="imp-content">
                                        <div class="imp-title">${escapeHtml(child.FieldName)}</div>
                                        <div class="imp-meta">
                                            <strong>Matches Control:</strong> ${escapeHtml(child.Control)}
                                            ${child.Role ? ` | <strong>Role:</strong> ${escapeHtml(child.Role)}` : ''}
                                        </div>
                                    </div>
                                `;
                                impList.appendChild(impItem);
                            });
                            subControlItem.appendChild(impList);
                        }
                        subControlList.appendChild(subControlItem);
                    });
                }
                regItem.appendChild(subControlList);
                container.appendChild(regItem);
            });
        }

        // Utility to prevent HTML injection from JSON data
        function escapeHtml(unsafe) {
            if (typeof unsafe !== 'string') return unsafe;
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
    </script>
</body>
</html>

