<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Onboarding Procedure</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
   <div class="steps-container">
        <div class="role-selection-container">
            <label for="dimension-dropdown">Select Trust Dimension:</label>
            <select id="dimension-dropdown">
                <option value="">All Trust Dimensions</option>
                <option value="Compliance">Compliance</option>
                <option value="Risk Management System">Risk Management System</option>
                <option value="Data and Data Governance">Data and Data Governance</option>
                <option value="Record-Keeping">Record-Keeping</option>
                <option value="Transparency and Explainability">Transparency and Explainability</option>
                <option value="Human Oversight">Human Oversight</option>
                <option value="Cybersecurity and Resilience">Cybersecurity and Resilience</option>
                <option value="Intended Use">Intended Use</option>
                <option value="Job Preservation">Job Preservation</option>
                <option value="Fairness and Bias">Fairness and Bias</option>
                <option value="Fundamental Rights">Fundamental Rights</option>
                <option value="AI Governance">AI Governance</option>
                <option value="Environmental Sustainability">Environmental Sustainability</option>
            </select>
        </div>
        <div class="role-selection-container">
            <label for="role-dropdown">Select Your Role:</label>
            <select id="role-dropdown">
                <option value="">All Roles</option>
                <option value="Requester">Requester</option>
                <option value="Engineer">Engineer</option> 
                <option value="Data Engineer">Data Engineer</option> 
                <option value="Compliance">Compliance</option>
                <option value="Tester">Tester</option> 
                <option value="Approver">Approver</option> 
                <option value="Deployment Engineer">Deployment Engineer</option> 
                <option value="Incident Manager">Incident Manager</option> 
                <option value="Operation & Monitoring Engineer">Operation & Monitoring Engineer</option> 
            </select>
        </div>
        <div class="progress-wrapper">
            <div class="progress-container">
                <div id="progress-bar"></div>
            </div>
            <div id="progress-text"></div>
        </div>
       <h1 id="steps-title">AI Onboarding Phases</h1>
       <div id="step-container"></div>
   </div>
    
    <div class="container">
        <h1 id="main-title">Loading...</h1>
        <div id="form-container"></div>
        <div class="button-container">
            <button id="prev-btn" style="display: none;">Previous</button>
            <button id="next-btn">Next</button>
            <button id="download-btn" style="display: none;">Download JSON</button>
        </div>
    </div>

    <script src="scripts/fieldHandler_note.js"></script>
    <script src="scripts/fieldHandler_autoGenerated.js"></script>
    <script src="scripts/fieldHandler_textBox.js"></script>
    <script src="scripts/fieldHandler_decision.js"></script>
    <script src="scripts/fieldHandler_dropdown.js"></script>
    <script src="scripts/fieldHandler_optionBox.js"></script>
    <script src="scripts/fieldHandler_label.js"></script>
    <script src="scripts/fieldHandler_risk.js"></script>
    <script src="scripts/fieldHandler_objective.js"></script>
    <script src="scripts/fieldHandler_multiselect.js"></script> 
    <script src="scripts/fieldHandler_plan.js"></script> 
    <script src="scripts/fieldHandler_fieldGroup.js"></script>
    <script src="scripts/fieldHandler_comply.js"></script>

    <script src="scripts/fieldFactory.js"></script>
    

    <script>
		document.addEventListener('DOMContentLoaded', () => {
				fetch('ai_onboarding_procedure_data.json')
					.then(response => {
						if (!response.ok) {
							throw new Error(`Network responses was not ok: ${response.statusText}`);
						}
						return response.json();
					})
					.then(webappData => {
						// We save the data to the window object so comply.js can read it
						window.originalWebappData = webappData; 
						// --------------------------						
						const formContainer = document.getElementById('form-container');
						const prevBtn = document.getElementById('prev-btn');
						const nextBtn = document.getElementById('next-btn');
						const downloadBtn = document.getElementById('download-btn');
						const mainTitle = document.getElementById('main-title');
						const progressBar = document.getElementById('progress-bar');
						const progressText = document.getElementById('progress-text');
						const stepContainer = document.getElementById('step-container');
						const roleDropdown = document.getElementById('role-dropdown'); 
						const dimensionDropdown = document.getElementById('dimension-dropdown'); 
		
						const originalWebappData = webappData;
						
						let procedureDataArray = [];
						let procedureSteps = [];
						const capturedData = {};
						let currentStepIndex = 0;
						
						let currentRole = roleDropdown.value;
						let currentDimension = dimensionDropdown.value;
		
						// --- NEW: DEEP FILTERING FUNCTION ---
						// Replaces fieldPassesFilters. Returns a cleaned COPY of the node.
						function getDeepFilteredNode(node) {
							if (!node) return null;
		
							const isRoleFilterActive = currentRole && currentRole !== "";
							const isDimFilterActive = currentDimension && currentDimension !== "";
							
							if (!isRoleFilterActive && !isDimFilterActive) return node; 
		
							let matchesDirectly = true;
							if (isRoleFilterActive) {
								if (!node.Role || !String(node.Role).split(',').map(r => r.trim()).includes(currentRole)) {
									matchesDirectly = false;
								}
							}
							if (isDimFilterActive && matchesDirectly) {
								if (!node.TrustDimension || !String(node.TrustDimension).split(',').map(d => d.trim()).includes(currentDimension)) {
									matchesDirectly = false;
								}
							}
		
							let filteredChildren = [];
							if (node.Fields && Array.isArray(node.Fields)) {
								filteredChildren = node.Fields.map(child => getDeepFilteredNode(child)).filter(child => child !== null);
							}
		
							if (matchesDirectly) {
								 return { ...node, Fields: filteredChildren };
							} else if (filteredChildren.length > 0) {
								 return { ...node, Fields: filteredChildren };
							}
		
							return null;
						}
		
						// --- UPDATED: FILTER INITIALIZATION ---
						function filterAndInitializeSteps() {
							currentStepIndex = 0; 
							const allStepsFlat = Object.values(originalWebappData).flat();
							
							// Uses Deep Filter to decide which steps to keep
							procedureDataArray = allStepsFlat.filter(step => getDeepFilteredNode(step) !== null);
							procedureSteps = procedureDataArray.map(step => step.StepName);
							
							renderProcedureSteps();
							
							if (procedureSteps.length > 0) {
								renderCurrentStep();
							} else {
								mainTitle.textContent = "No Relevant Steps Available";
								formContainer.innerHTML = "<p>No steps match the current Role and/or Trust Dimension filters.</p>";
								prevBtn.style.display = 'none';
								nextBtn.style.display = 'none';
								downloadBtn.style.display = 'none';
								updateProgressBar(); 
							}
						}
		
						// --- KEEPER: SIDEBAR NAVIGATION RENDERER ---
						function renderProcedureSteps() {
							stepContainer.innerHTML = '';
							
							for (const [phaseName, stepsInPhase] of Object.entries(originalWebappData)) {
								// Find which steps from this phase are currently visible after filtering
								const visiblePhaseSteps = stepsInPhase.filter(step => 
									procedureSteps.includes(step.StepName)
								);
		
								if (visiblePhaseSteps.length > 0) {
									const phaseHeader = document.createElement('div');
									phaseHeader.className = 'phase-header';
									phaseHeader.textContent = phaseName;
									stepContainer.appendChild(phaseHeader);
		
									visiblePhaseSteps.forEach(step => {
										const stepDiv = document.createElement('div');
										stepDiv.className = 'step-item';
										// Find the TRUE index of this step in the filtered array
										const trueIndex = procedureSteps.indexOf(step.StepName);
										stepDiv.id = `step-item-${trueIndex}`; 
		
										const iconSpan = document.createElement('span');
										iconSpan.className = 'icon';
										stepDiv.appendChild(iconSpan);
		
										const textSpan = document.createElement('span');
										textSpan.textContent = step.StepName;
										stepDiv.appendChild(textSpan);
										
										stepDiv.addEventListener('click', () => {
											currentStepIndex = trueIndex;
											renderCurrentStep();
										});
		
										stepContainer.appendChild(stepDiv);
									});
								}
							}
						}
						
						function updateStepHighlight() {
							procedureSteps.forEach((_, index) => {
								const stepDiv = document.getElementById(`step-item-${index}`);
								if (stepDiv) {
									stepDiv.classList.remove('active-step', 'completed-step');
									if (index < currentStepIndex) {
										stepDiv.classList.add('completed-step');
									} else if (index === currentStepIndex) {
										stepDiv.classList.add('active-step');
									}
								}
							});
						}
						
						function sanitizeForId(text) {
							if (typeof text !== 'string') return '';
							return text.replace(/[^a-zA-Z0-9_]/g, '_');
						}
		
						// --- UPDATED: CURRENT STEP RENDERER ---
						function renderCurrentStep() {
							updateProgressBar();
							updateStepHighlight();
							
							const originalStepData = procedureDataArray[currentStepIndex];
							if (!originalStepData) return; 
		
							prevBtn.style.display = currentStepIndex > 0 ? 'inline-block' : 'none';
							nextBtn.style.display = 'inline-block';
							downloadBtn.style.display = 'none';
		
							mainTitle.textContent = originalStepData.StepName || "Procedure Step";
							formContainer.innerHTML = '';
		
							const formStepDiv = document.createElement('div');
							formStepDiv.className = 'form-step';
		
							if (originalStepData.Objectives && originalStepData.Objectives.length > 0) {
								const handler = getFieldHandler('objective');
								if (handler) formStepDiv.appendChild(handler(originalStepData.Objectives));
							};
		
							let renderedFieldCount = 0;
							if (!originalStepData.Fields || originalStepData.Fields.length === 0) {
								 if (currentDimension === "" && currentRole === "" && typeof createNoteField === 'function') {
									formStepDiv.appendChild(createNoteField());
									renderedFieldCount++;
								 }
							} else {
								// Pass 1: Filter the fields using Deep Filter
								// Pass 2: Render the resulting filtered nodes
								originalStepData.Fields.forEach(originalField => {
									const filteredField = getDeepFilteredNode(originalField);
									if (filteredField) {
										const handler = getFieldHandler(filteredField.FieldType);
										if (handler) {
											formStepDiv.appendChild(handler(filteredField, capturedData, sanitizeForId));
											renderedFieldCount++;
										}
									}
								});
							}
							
							if (renderedFieldCount === 0) {
								 formContainer.innerHTML = `<p>No fields match the selected filters in this step.</p>`;
							} else {
								formContainer.appendChild(formStepDiv);
							}
						}
						
						function updateProgressBar() {
							const totalSteps = procedureSteps.length;
							if (totalSteps === 0) {
								progressText.textContent = `No steps selected`;
								progressBar.style.width = '0%';
								return;
							}
							if (currentStepIndex < totalSteps) {
								progressText.textContent = `Step ${currentStepIndex + 1} of ${totalSteps}`;
							} else {
								 progressText.textContent = `Completed ${totalSteps} of ${totalSteps}`;
							}
							const progressPercentage = totalSteps > 1 ? ((currentStepIndex) / (totalSteps - 1)) * 100 : (totalSteps === 1 ? (currentStepIndex === 0 ? 0 : 100) : 100);
							progressBar.style.width = progressPercentage + '%';
						}
		
						prevBtn.addEventListener('click', () => {
							if (currentStepIndex > 0) {
								currentStepIndex--;
								renderCurrentStep();
							}
						});
		
						nextBtn.addEventListener('click', () => {
							if (procedureSteps.length === 0) return;
		
							// Capture data from currently visible fields
							const stepData = procedureDataArray[currentStepIndex];
							if (stepData && stepData.Fields) {
								capturedData['Step: ' + currentStepIndex] = procedureSteps[currentStepIndex];
								
								// We must only capture data from fields that passed the filter
								stepData.Fields.forEach(field => {
									 const filteredField = getDeepFilteredNode(field);
									 // Helper to recursively capture data from a filtered node tree
									 function captureFromNode(node) {
										 if (!node) return;
										 if (node.FieldName && node.FieldType !== 'Auto generated number' && node.FieldType !== 'fieldGroup') {
											 const sanitizedId = sanitizeForId(node.FieldName);
											 const inputElement = document.getElementById(sanitizedId);
											 if (inputElement) {
												if (inputElement.type === 'radio') {
													const checked = document.querySelector(`input[name="${sanitizedId}"]:checked`);
													if(checked) capturedData[' - ' + node.FieldName] = checked.value;
												} else {
													capturedData[' - ' + node.FieldName] = inputElement.value;
												}
											 }
										 }
										 if (node.Fields) node.Fields.forEach(captureFromNode);
									 }
									 captureFromNode(filteredField);
								});
							}
		
							currentStepIndex++;
							if (currentStepIndex < procedureSteps.length) {
								renderCurrentStep();
							} else {
								formContainer.innerHTML = '<h2>Onboarding procedure completed!</h2><p>You can now download the generated JSON file.</p>';
								mainTitle.textContent = "Finished";
								nextBtn.style.display = 'none';
								prevBtn.style.display = 'none';
								downloadBtn.style.display = 'block';
								procedureSteps.forEach((_, index) => {
								   const stepItem = document.getElementById(`step-item-${index}`);
								   if(stepItem) {
									   stepItem.classList.remove('active-step');
									   stepItem.classList.add('completed-step');
								   }
								});
								updateProgressBar();
							}
						});
		
						downloadBtn.addEventListener('click', () => {
							const jsonData = JSON.stringify(capturedData, null, 4);
							const blob = new Blob([jsonData], { type: 'application/json' });
							const url = URL.createObjectURL(blob);
							const a = document.createElement('a');
							a.href = url;
							a.download = 'onboarding_documentation.json';
							document.body.appendChild(a);
							a.click();
							document.body.removeChild(a);
							URL.revokeObjectURL(url);
						});
		
						roleDropdown.addEventListener('change', (event) => {
							currentRole = event.target.value;
							for (const key in capturedData) delete capturedData[key];
							filterAndInitializeSteps(); 
						});
						
						dimensionDropdown.addEventListener('change', (event) => {
							currentDimension = event.target.value;
							for (const key in capturedData) delete capturedData[key];
							filterAndInitializeSteps();
						});
		
						filterAndInitializeSteps();
					})
					.catch(error => {
						console.error('Error loading the webapp data:', error);
						mainTitle.textContent = "Error";
						formContainer.innerHTML = "<p>Failed to load procedure data.</p>";
					});
			});
    </script>
</body>
</html>